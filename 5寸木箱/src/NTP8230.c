

#include "NTP8230.h"
#define	NTP8230_GLOBALS
/*******I2C Address  0x54*****
 ************AD = 0  0X54*****
 ************AD = 1  0X56*****/

//I2C Address  0x54(0x54+0)  is  write to NTP-8230
//I2C Address  0x55(0x54+1)  is  read from NTP-8230
/****Single Byte Write Mode Sequence****/
//@a	start + SlaveAddress + w + A + AIF + SubAddress + A + Data + A + stop
//@b	start + SlaveAddress + w + A + AIF + SubAddress#1 + A + Data#1 + A + AIF + SubAddress#2 + A + Data#2 + A +..... stop
//@c	start + SlaveAddress + w + A + AIF + SubAddress#1 + A + Data#1 + A + ..... Data#n + A + stop

/****Quad Byte Write Mode Sequence*****/
//@a	start + SlaveAddress + w + A + AIF + SubAddress + A + Data(Byte#4) + A + Data(Byte#3) + A +Data(Byte#2) + A +Data(Byte#1) + A + stop

//0x7e  PLL:0x02
//Addr 0x00: Audio Input Format
//Addr 0x01: General Serial Audio Format
//Addr 0x02: Master Clock Frequency Control
//Addr 0x03~0x08: Mixer Gain
//Reserved Addr 0x09~0x0B
//Addr 0x0C : Front Bi-quad Filter Chain (FBQ) Configurations for Ch 1&2&3
//Addr 0x0D: 3D Delay Amount
//Addr 0x0E: 3D Effect Control Configuration
//Addr 0x0F : Equalizer (EQ) Configuration
//Addr 0x10~0x14: GEQ Gain for Band 1 ~ 5
//Addr 0x15: CH1&CH2 Prescaler Value Configuration
//Addr 0x16: CH3 Prescaler Value Configuration
//Addr 0x17~0x18: Post Biquad Filter (PBQ) Configuration0 for Ch 1 and Ch2, respectively
//Addr 0x19~0x1A : Post Biquad Filter (PBQ) Configuration1 for Ch 1 and Ch 2, respectively
//Addr 0x1B : Post Biquad Filter (PBQ) Configuration for Ch 3
//Addr 0x1C: DRC Control 0
//Addr 0x1D : DRC Control 1
//Addr 0x1E : DRC Control 2
//Addr 0x1F : DRC Control3
//Addr 0x20 : DRC Control 4
//Addr 0x21: DRC Control 5
//Addr 0x22 : DRC Control 6
//Addr 0x23: DRC Control 7
//Addr 0x24 : DRC Control 8
//Addr 0x25 : DRC Control 9
//Addr 0x26 : Soft Mute Control 0
//Addr 0x27 : PWM Switching On/Off Control
//Addr 0x28 : PWM_MASK Control 0
//Addr 0x29: PWM_MASK Control 1
//Addr 0x2A : PWM_MASK Control 2
//Addr 0x2B : PWM_MASK Control 3
//Addr 0x2C: PWM_MASK Control 4
//Addr 0x2D: Master Volume Fine Control
//Addr 0x2E~0x31: Master Volume, and Ch1/2/3 volume, respectively
//Addr 0x32: Soft Volume Control
//Addr 0x33: Auto-Mute Control for CH1 & CH2
//Addr 0x34: Auto-Mute Control for CH3
//Addr 0x35 : PWM Output Port Control for PWM Port 1A & 1B
//Addr 0x36 : PWM Output Port Control for PWM Port 2A & 2B
//Addr 0x37 : PWM Output Port Control for PWM port 3A & 3B
//Addr 0x38: Miscellaneous PWM Control
//Addr 0x39: I 2 C Glitch filter
//Addr 0x3A : Headphone Mute Control
//Reserved Addr 0x3B~0x49
//Addr 0x4A : SE Soft Start Control 0
//Addr 0x4B : SE Soft Start Control 1
//Addr 0x4C : SE Soft Start Control 2
//Addr 0x4D : SE Soft Start Control 3
//Addr 0x4E : PWM D-BTL MODE Control 0
//Reserved Addr 0x4F
//Addr 0x50 : PWM D-BTL Mode Control 1
//Reserved Addr 0x51
//Addr 0x52 : PWM Soft Start
//Addr 0x53: Power Meter Control
//Addr 0x54: Power Meter (read-only)
//Addr 0x55: Modulation Index & NS-Type Control
//Reserved Addr 0x56~0x5D
//Addr 0x5E: System Error Status (read-only)
//Addr 0x5F: Monitor
//Reserved Addr 0x60~0x61
//Addr 0x62: Driver Control
//Reserved Addr 0x63~0x7D
//Addr 0x7E: Bi-Quad Filter Coefficient Page
//Addr 0x7F: Chip ID 0x99

// 0x2e
// 0x03-0x08
// 0x15 0x16
// 0x1c-0x24				0x54  0x26
// 0x39
// 0x4b 0x4c
// 0x52
uint8_t Soft_Mute_flag = 0x00;
uint8_t PWM_Switching_flag = 0x00;
uint32_t Power_Meter = 0x00;

void NTP_8230_INIT(void)
{
	I2C_SW_Send( 0x54,NTP_8230,350);
}
void Soft_Mute(void)		//0x26
{
	if( Soft_Mute_flag )
	{
		NTP_8230_REG[77] = 0x07;
		I2C_SW_Send(0x54,NTP_8230_REG+76,2);
	}
	else
	{
		NTP_8230_REG[77] = 0x00;
		I2C_SW_Send(0x54,NTP_8230_REG+76,2);
	}
}
void PWM_Switching(void)	//0x27
{
	if( PWM_Switching_flag )
	{
		NTP_8230_REG[79] = 0x07;
		I2C_SW_Send(0x54,NTP_8230_REG+78,2);
	}
	else
	{
		NTP_8230_REG[79] = 0x00;
		I2C_SW_Send(0x54,NTP_8230_REG+78,2);
	}
}
void PWM_MASK(void)			//0x28
{
		NTP_8230_REG[81] = 0x02;
		I2C_SW_Send(0x54,NTP_8230_REG+80,2);
}
void Driver_Control(void)	//0x62
{
		NTP_8230_REG[197] = 0x0A;
		I2C_SW_Send(0x54,NTP_8230_REG+196,2);
}
void Power_Meter_Control(void)		//0x53
{
	NTP_8230_REG[167] = 0x00;
	I2C_SW_Send(0x54,NTP_8230_REG+166,2);
}
void Power_Meter_Detect(void)		//0x54
{
//	I2C_SW_Send(0x54,NTP_8230_REG+168,1);
	I2C_SW_Get(0x54,NTP_8230_REG+168,1);
	if(NTP_8230_REG[169]>0x90)
	{
//		Power_Meter++;
		if(Power_Meter>3000000)
		{
			Soft_Mute_flag = 1;
			Soft_Mute();
		}
	}
	else
	{
		Soft_Mute_flag = 0;
		Soft_Mute();
		Power_Meter = 0;
	}
}
void VOL_A_TASK(void)
{
	;
}
void VOL_B_TASK(void)
{
	;
}
void TREBLE_A_TASK(void)
{
	;
}
void TREBLE_B_TASK(void)
{
	;
}
void SUB_A_TASK(void)
{
	;
}	
void SUB_B_TASK(void)
{
	;
}	
void POWER_TASK(void)
{
	;
}	

uint8_t NTP_8230[]=
	{     
			  0x02,     0x00,// 主时钟频率控制 12.288MHZ
              0x00,     0x00,//音频输入格式 I2S slave mode
              0x2E,     0xCF,//主控音量
              0x2D,     0x00,//主控音量精细控制
              0x2F,     0xCF,
              0x30,     0xCF,
              0x31,     0xCF,
              0x15,     0xE7,//分频器值  Prescaler Value Configuration
              0x16,     0xB3,
              0x2C,     0x43,//PWM_MASK Control 4
              0x52,     0x90,//PWM Soft Start
              0x62,     0x1A,//Driver Control
              0x01,     0x00,
              0x03,     0x4E,//Mixer Gain
              0x04,     0x00,
              0x05,     0x00,
              0x06,     0x4E,
              0x07,     0x36,
              0x08,     0x36,//Mixer Gain
              0x32,     0x00,// Soft Volume Control
              0x0F,     0x00,//Equalizer (EQ) Configuration
              0x10,     0x00,
              0x11,     0x00,
              0x12,     0x00,
              0x13,     0x00,
              0x14,     0x00,
              0x33,     0x00,//Auto-Mute Control
              0x34,     0x00,
              0x55,     0x0F,//Modulation Index & NS-Type Control
              0x2B,     0x0B,
              0x35,     0x08,
              0x36,     0x1A,
              0x37,     0x2C,
              0x1C,     0x80,
              0x1D,     0x01,
              0x1E,     0x00,
              0x25,     0x00,
              0x22,     0x00,
              0x20,     0x00,
              0x7E,     0x03,
              0x00,     0x10,0x7F,0x66,0xFF,
              0x01,     0x11,0xFF,0x66,0xFF,
              0x02,     0x10,0x7F,0x66,0xFF,
              0x03,     0x11,0x7F,0x66,0xD2,
              0x04,     0x10,0xFE,0xCE,0x56,
              0x05,     0x11,0x00,0x00,0x00,
              0x06,     0x20,0x00,0x00,0x00,
              0x07,     0x20,0x00,0x00,0x00,
              0x08,     0x20,0x00,0x00,0x00,
              0x09,     0x20,0x00,0x00,0x00,
              0x14,     0x11,0x00,0x00,0x00,
              0x15,     0x20,0x00,0x00,0x00,
              0x16,     0x20,0x00,0x00,0x00,
              0x17,     0x20,0x00,0x00,0x00,
              0x18,     0x20,0x00,0x00,0x00,
              0x19,     0x11,0x00,0x00,0x00,
              0x1A,     0x20,0x00,0x00,0x00,
              0x1B,     0x20,0x00,0x00,0x00,
              0x1C,     0x20,0x00,0x00,0x00,
              0x1D,     0x20,0x00,0x00,0x00,
              0x1E,     0x11,0x00,0x00,0x00,
              0x1F,     0x20,0x00,0x00,0x00,
              0x20,     0x20,0x00,0x00,0x00,
              0x21,     0x20,0x00,0x00,0x00,
              0x22,     0x20,0x00,0x00,0x00,
              0x23,     0x11,0x00,0x00,0x00,
              0x24,     0x20,0x00,0x00,0x00,
              0x25,     0x20,0x00,0x00,0x00,
              0x26,     0x20,0x00,0x00,0x00,
              0x27,     0x20,0x00,0x00,0x00,
              0x28,     0x11,0x00,0x00,0x00,
              0x29,     0x20,0x00,0x00,0x00,
              0x2A,     0x20,0x00,0x00,0x00,
              0x2B,     0x20,0x00,0x00,0x00,
              0x2C,     0x20,0x00,0x00,0x00,
              0x2D,     0x11,0x00,0x00,0x00,
              0x2E,     0x20,0x00,0x00,0x00,
              0x2F,     0x20,0x00,0x00,0x00,
              0x30,     0x20,0x00,0x00,0x00,
              0x31,     0x20,0x00,0x00,0x00,
              0x32,     0x11,0x00,0x00,0x00,
              0x33,     0x20,0x00,0x00,0x00,
              0x34,     0x20,0x00,0x00,0x00,
              0x35,     0x20,0x00,0x00,0x00,
              0x36,     0x20,0x00,0x00,0x00,
              0x37,     0x11,0x00,0x00,0x00,
              0x38,     0x20,0x00,0x00,0x00,
              0x39,     0x20,0x00,0x00,0x00,
              0x3A,     0x20,0x00,0x00,0x00,
              0x3B,     0x20,0x00,0x00,0x00,
              0x7E,     0x00,
              0x0C,     0x3F,
              0x17,     0x1F,
              0x19,     0x15,
              0x18,     0x1F,
              0x1A,     0x15,
              0x1B,     0x15,
              0x28,     0x04,
              0x27,     0x00,
              0x26,     0x07
	};		

uint8_t NTP_8230_REG[] = 
{
	0x00,0x00,
	0x01,0x00,
	0x02,0x00,
	0x03,0x00,
	0x04,0x00,
	0x05,0x00,
	0x06,0x00,
	0x07,0x00,
	0x08,0x00,
	0x09,0x00,
	0x0a,0x00,
	0x0b,0x00,
	0x0c,0x00,
	0x0d,0x01,
	0x0e,0x00,
	0x0f,0x00,
	0x10,0x00,
	0x11,0x00,
	0x12,0x00,
	0x13,0x00,
	0x14,0x00,
	0x15,0xd0,
	0x16,0xd0,
	0x17,0x00,
	0x18,0x00,
	0x19,0x00,
	0x1a,0x00,
	0x1b,0x00,
	0x1c,0x00,
	0x1d,0x01,
	0x1e,0x00,
	0x1f,0x01,
	0x20,0x00,
	0x21,0x01,
	0x22,0x00,
	0x23,0x41,
	0x24,0x14,
	0x25,0x00,
	0x26,0x07,
	0x27,0x07,
	0x28,0x02,
	0x29,0x00,
	0x2a,0x00,
	0x2b,0x0b,
	0x2c,0x43,
	0x2d,0x00,
	0x2e,0x00,
	0x2f,0xcf,
	0x30,0xcf,
	0x31,0xcf,
	0x32,0x00,
	0x33,0x00,
	0x34,0x00,
	0x35,0x08,
	0x36,0x1a,
	0x37,0x2c,
	0x38,0x00,
	0x39,0x0f,
	0x3a,0x00,
	0x3b,0x00,
	0x3c,0x00,
	0x3d,0x00,
	0x3e,0x00,
	0x3f,0x00,
	0x40,0x00,
	0x41,0x00,
	0x42,0x00,
	0x43,0x00,
	0x44,0x00,
	0x45,0x00,
	0x46,0x00,
	0x47,0x00,
	0x48,0x00,
	0x49,0x00,
	0x4a,0x00,
	0x4b,0x22,
	0x4c,0x01,
	0x4d,0x01,
	0x4e,0x08,
	0x4f,0x00,
	0x50,0x00,
	0x51,0x00,
	0x52,0x90,
	0x53,0x00,
	0x54,0x00,
	0x55,0x0f,
	0x56,0x00,
	0x57,0x00,
	0x58,0x00,
	0x59,0x00,
	0x5a,0x00,
	0x5b,0x00,
	0x5c,0x00,
	0x5d,0x00,
	0x5e,0x00,
	0x5f,0x65,
	0x60,0x00,
	0x61,0x00,
	0x62,0x08,
	0x63,0x00,
	0x64,0x00,
	0x65,0x00,
	0x66,0x00,
	0x67,0x00,
	0x68,0x00,
	0x69,0x00,
	0x6a,0x00,
	0x6b,0x00,
	0x6c,0x00,
	0x6d,0x00,
	0x6e,0x00,
	0x6f,0x00,
	0x70,0x00,
	0x71,0x00,
	0x72,0x00,
	0x73,0x00,
	0x74,0x00,
	0x75,0x00,
	0x76,0x00,
	0x77,0x00,
	0x78,0x00,
	0x79,0x00,
	0x7a,0x00,
	0x7b,0x00,
	0x7c,0x00,
	0x7d,0x00,
	0x7e,0x00,
	0x7f,0x99,
};	

